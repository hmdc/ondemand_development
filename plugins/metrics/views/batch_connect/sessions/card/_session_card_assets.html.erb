<style>

    table.metrics th {
        font-size: 0.9rem;
    }
    table.metrics td {
        font-size: 0.8rem;
    }

    .job-metrics i.app-icon {
        width: 0.8rem;
        height: 0.8rem;
        font-size: 0.8rem;
        vertical-align: 1px;
        color: #6c757d;
    }

    div.job-metric-details {
        overflow: hidden;
    }

    div.job-metric-details [title]{
        cursor: default;
    }

    div.job-metric-details table {
        margin-top: 0.5rem;
    }

    div.job-metric-details .text-dark {
        --bs-text-opacity: 0.8;
    }

    p.job-metrics-description {
        cursor: pointer;
        margin: 0;
    }

    p[aria-expanded=true] .closed {
        display: none;
    }

    p[aria-expanded=false] .open {
        display: none;
    }

</style>
<script>
  // TESTED WITH OOD 3.x and 4.0
  // OVERRIDE OOD replaceHTML FUNCTION TO INTERCEPT THE AJAX RESPONSE FOR THE SESSION CARDS.
  // WE WANT TO KEEP THE METRICS COLLAPSABLE STATE BETWEEN AJAX REFRESH
  const originalFunction = window.replaceHTML;
  const metricsCollapseState = {};

  window.replaceHTML = function(id, html) {
    const ele = document.getElementById(id);

    if(ele == null) {
      return;
    }

    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const sessionCards = tmp.querySelector('template');

    // UPDATE COLLAPSABLE ITEMS
    sessionCards.content.querySelectorAll('.job-metric-details .collapse').forEach((element) => {
      const jobMetricsId = element.dataset.sessionId;
      const isOpen = metricsCollapseState[jobMetricsId];

      if (isOpen) {
        element.classList.remove('collapse');
        element.classList.add('show');
      }
    });

    // UPDATE BUTTONS
    sessionCards.content.querySelectorAll('.job-metrics-description').forEach((element) => {
      const jobMetricsId = element.dataset.sessionId;
      const isOpen = metricsCollapseState[jobMetricsId];

      if (isOpen) {
        element.setAttribute('aria-expanded', 'true');
      }
    });

    const updatedSessionCards = sessionCards.innerHTML;
    tmp.remove();

    setInnerHTML(ele, updatedSessionCards);
  };

  // LISTEN TO BOOTSTRAP COLLAPSABLE OPEN AND CLOSE EVENTS
  jQuery(function (){
    $('#batch_connect_sessions').on('hide.bs.collapse', function (element) {
      // ENSURE IS ONE OF THE METRICS COLLAPSABLE
      if (element.target.dataset.sessionId) {
        metricsCollapseState[element.target.dataset.sessionId] = false;
      }
    })

    $('#batch_connect_sessions').on('show.bs.collapse', function (element) {
      // ENSURE IS ONE OF THE METRICS COLLAPSABLE
      if (element.target.dataset.sessionId) {
        metricsCollapseState[element.target.dataset.sessionId] = true;
      }
    })
  });

</script>